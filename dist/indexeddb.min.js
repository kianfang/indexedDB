/*! indexedDB 2016-11-22 */
!function(a,b){a.indexedDB=a.indexedDB||a.webkitIndexedDB||a.mozIndexedDB||a.msIndexedDB,a.IDBTransaction=a.IDBTransaction||a.webkitIDBTransaction||a.msIDBTransaction,a.IDBKeyRange=a.IDBKeyRange||a.webkitIDBKeyRange||a.msIDBKeyRange,a.IDBCursor=a.IDBCursor||a.webkitIDBCursor||a.msIDBCursor;var c=function(a,b,c){var d,e,f=[];for(d in c)switch(c[d][1]){case"primary":e=a.createObjectStore(b,{keyPath:c[d][0],autoIncrement:"AI"===c[d][2]});break;case"relation":f.push([c[d][0]+"Index",c[d][2],{unique:!1,multiEntry:!1}]);break;default:f.push([c[d][0]+"Index",c[d][0],{unique:"unique"===c[d][1],multiEntry:"ME"===c[d][2]}])}void 0===e.name&&(e=a.createObjectStore(b,{keyPath:"id",autoIncrement:!0}));for(d in f)e.createIndex(f[d][0],f[d][1],f[d][2])},d=function(b){var c;switch(b[0]){case"gt":c=a.IDBKeyRange.lowerBound(b[1],void 0===b[2]||b[2]);break;case"lt":c=a.IDBKeyRange.upperBound(b[1],void 0===b[2]||b[2]);break;case"bt":c=a.IDBKeyRange.bound(b[1][0],b[1][1],void 0===b[2]||b[2],void 0===b[3]||b[3]);break;case"eq":c=a.IDBKeyRange.only(b[1]);break;case"lk":c=a.IDBKeyRange.includes(b[1]);break;default:c=!1}return c},e=function(a){return"function"==typeof a},f=function(a){if(e(a))throw"this is Function";var b=!0;for(var c in a){b=!1;break}return b},g=function(a){var b=function(b){h.call(this,b),this.result=a.DB,delete this.database,delete this.version,delete this.initialCollections};b.prototype={constructor:b,getDatabase:function(){return this.result.database},find:function(a,b){void 0===a&&(a=["*"]),e(a)&&(b=a,a=["*"]),this.on("success",b),this.on("error",b);var c=this.getDatabase().transaction([this.name],"readonly").objectStore(this.name),f=0,g=[],h="*"===a[0]?null:d(a[1]),i=this,j=function(b){var c=b.target.result;c?(f++,g.push(c.value),c.continue()):i.emit("success",{error:0,message:"select success of total "+f,data:{result:g,total:f,query:a}})};return c.transaction.onerror=function(a){i.emit("error",{error:1010,message:"find error",data:a})},a[0]===c.keyPath||"*"===a[0]?c.openCursor(h,void 0===a[2]?"prev":a[2]).onsuccess=function(a){j(a)}:c.index(a[0]+"Index").openCursor(h,void 0===a[2]?"prev":a[2]).onsuccess=function(a){j(a)},this},insert:function(a,b){this.on("success",b),this.on("error",b);var c=this.database.transaction([this.name],"readwrite").objectStore(this.name);return c.add(a).onsuccess=function(a){b({error:0,message:"add success!",index:a.target.result})},this},batchInsert:function(a,b){this.on("success",b),this.on("error",b);var c=this,d=this.getDatabase().transaction([this.name],"readwrite").objectStore(this.name),e=null===a||void 0===a?0:a.length;if(0===e)c.emit("error",{error:1,message:"no data!"});else for(var f=0;f<e;f++)d.add(a[f]).onsuccess=function(a){c.emit("success",{error:0,message:"save success!",data:{total:e,index:a.target.result}})};return this},update:function(a,b){if(this.on("success",b),this.on("error",b),void 0===a||f(a))throw"no update data";var c=this.getDatabase().transaction([this.name],"readwrite").objectStore(this.name);return c.put(a).onsuccess=function(a){b({error:0,message:"save success!"})},this},remove:function(a,b){("function"==typeof a||f(a))&&(b=a,a=["*"]),this.on("success",b),this.on("error",b);var c=this.getDatabase().transaction([this.name],"readwrite").objectStore(this.name),e=this;if("*"===a[0])c.clear().onsuccess=function(a){e.emit("success",{error:0,message:"clear success!"})};else{var g=d(a[1]),h=0,i=function(a){var b=a.target.result;b?(h++,window.console.log(b),b.delete(),b.continue()):e.emit("success",{error:0,message:"delete success of total "+h,data:{total:h}})};a[0]===c.keyPath?c.openCursor(g).onsuccess=function(a){window.console.log(g),i(a)}:c.index(a[0]+"Index").openCursor(g).onsuccess=function(a){i(a)}}return this},count:function(a){this.on("success",a),this.on("error",a);var b=this.getDatabase().transaction([this.name],"readwrite").objectStore(this.name),c=this;return b.transaction.onerror=function(a){c.emit("error",{error:0,message:"action fail!",data:a})},b.count().onsuccess=function(a){c.emit("success",{error:0,message:"total "+a.target.result+" !",data:{count:a.target.result}}),console.log(a.target.result)},this},drop:function(a){this.on("success",a),this.on("error",a);var b=this.result.updateVersion(this.getDatabase());console.log(b);var c=this;return b.onupgradeneeded=function(a){c.result.database=a.target.result,c.getDatabase().deleteObjectStore(c.name),delete c.result[c.name],c.emit("success",{error:0,message:c.name+" removed and version update to "+c.getDatabase().version+"!"})},this}},a.DB[a.collectionName]=new b(a.collectionName)},h=function(a,b){"use strict";if(this.name=a,void 0===this.name)throw"name is empty!";this.initialCollections=b?b:{},this.database=null,this.type="indexedDB",this.version=void 0,this.emit=function(a,b){var c=this["on"+a];"function"==typeof c&&c(b)},this.on=function(a,b){return"function"==typeof b&&(this["on"+a]=b),this}};h.prototype={constructor:h,open:function(b){if(this.on("open",b),this.on("success",b),this.on("error",b),this.on("open",b),null===a.indexedDB)throw"indexedDB don't support!";var d=a.indexedDB.open(this.name,this.version),e=this;return d.onupgradeneeded=function(a){for(var b in e.initialCollections)c(a.target.result,b,e.initialCollections[b])},d.onsuccess=function(a){e.database=a.target.result,e.version=e.database.version;for(var b in e.initialCollections)g({DB:e,collectionName:b});e.emit("open",{error:0,message:"open success!",result:e})},d.onerror=function(a){e.emit("error",{error:0,message:"open database fail!",result:a})},this},updateVersion:function(b){return b.close(),this.version++,a.indexedDB.open(this.name,this.version)},getCollection:function(a){return this[a]},drop:function(b){return a.indexedDB.deleteDatabase(b||this.name),this}},a[b]=h}(window,"DB");