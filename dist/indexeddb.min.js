/*! indexedDB 2016-11-14 */
window.indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,window.IDBCursor=window.IDBCursor||window.webkitIDBCursor||window.msIDBCursor;var DB=function(a,b){"use strict";function c(a,b){var c,e,f=[];for(c in b)switch(b[c][1]){case"primary":e=d.db.createObjectStore(a,{keyPath:b[c][0],autoIncrement:"AI"===b[c][2]});break;case"relation":f.push([b[c][0]+"Index",b[c][2],{unique:!1,multiEntry:!1}]);break;default:f.push([b[c][0]+"Index",b[c][0],{unique:"unique"===b[c][1],multiEntry:"ME"===b[c][2]}])}void 0===e.name&&(e=d.db.createObjectStore(a,{keyPath:"id",autoIncrement:!0}));for(c in f)f.hasOwnProperty(c)&&e.createIndex(f[c][0],f[c][1],f[c][2])}var d=this,e=window.indexedDB,f=function(a,b){window.console.log(a);var c=a.target.error.message,e=-1;null!==c.match(/least one key|already exists/gi)&&(e=6),d.callback({error:e,message:a.target.error.message})};d.name=a,d.db={},d.callback=function(){},d.errCodeInfo=["操作成功！","","","","","","记录已存在，无法重复操作！"],this.open=function(g,h){if(void 0!==e){if(d.type="DB",d.name=a||d.type,void 0!==d.db&&void 0!==h)return d.db.close(),e.open(d.name,h);var i=e.open(d.name);return i.onupgradeneeded=function(a){d.db=a.target.result;for(var e in b)c(e,b[e])},i.onsuccess=function(a){d.db=a.target.result,d.version=d.db.version,g({error:0,message:"open success!",DB:d})},d.callback=g,i.onerror=f,window.console.log(d.name+" create success in indexedDB!"),d}},this.table=function(a){var b=this.table,e=-1;return"DB"===d.type?(b.getKeyRangeValue=function(a){var b;switch(a[0]){case"gt":b=window.IDBKeyRange.lowerBound(a[1],void 0===a[2]||a[2]);break;case"lt":b=window.IDBKeyRange.upperBound(a[1],void 0===a[2]||a[2]);break;case"bt":b=window.IDBKeyRange.bound(a[1][0],a[1][1],void 0===a[2]||a[2],void 0===a[3]||a[3]);break;case"eq":b=window.IDBKeyRange.only(a[1]);break;case"lk":b=window.IDBKeyRange.includes(a[1]);break;default:b=!1}return b},b.create=function(b,e){var g=d.open(null,d.db.version+1);return g.onupgradeneeded=function(e){d.db=e.target.result,c(a,b)},g.onerror=f,d},b.remove=function(b){var c=d.open(null,d.db.version+1);return c.onupgradeneeded=function(c){d.db=c.target.result,d.db.deleteObjectStore(a),b({error:0,message:a+" removed and version update to "+d.db.version+"!"})},d.callback=b,c.onerror=f,d},b.limit=function(a){return e=a,b},b.select=function(c,g){var h=d.db.transaction([a],"readonly").objectStore(a),i=0,j=[],k="*"===c[0]?null:b.getKeyRangeValue(c[1]),l=function(a,b){var d=a.target.result;d&&e!==i?(i++,j.push(d.value),d.continue()):b({error:0,message:"select success of total "+i,data:j,total:i,query:c})};return d.callback=g,h.transaction.onerror=f,c[0]===h.keyPath||"*"===c[0]?h.openCursor(k,void 0===c[2]?"prev":c[2]).onsuccess=function(a){l(a,g)}:h.index(c[0]+"Index").openCursor(k,void 0===c[2]?"prev":c[2]).onsuccess=function(a){l(a,g)},d},b.find=function(b,c){var e=d.db.transaction([a],"readonly").objectStore(a);return d.callback=c,e.transaction.onerror=f,b[0]===e.keyPath?e.get(b[1]).onsuccess=function(a){c({error:0,message:"find success!",data:a.target.result})}:e.index(b[0]+"Index").get(b[1]).onsuccess=function(a){c({error:0,message:"find success!",data:a.target.result})},d},b.add=function(b,c){var e=d.db.transaction([a],"readwrite").objectStore(a);return d.callback=c,e.transaction.onerror=f,e.add(b[0]||b).onsuccess=function(a){c({error:0,message:"add success!",index:a.target.result})},d},b.addAll=function(b,c){for(var e=d.db.transaction([a],"readwrite").objectStore(a),f=b.length,g=0;g<f;g++)e.add(b[g]).onsuccess=function(a){c({error:0,message:"add success!",data:{total:f,index:a.target.result}})};return d},b.save=function(b,c){var e=d.db.transaction([a],"readwrite").objectStore(a);return e.put(b).onsuccess=function(a){c({error:0,message:"save success!"})},d},b.saveAll=function(b,c){var e=d.db.transaction([a],"readwrite").objectStore(a),f=null===b||void 0===b?0:b.length;if(0===f)c({error:1,message:"no data!"});else for(var g=0;g<f;g++)e.put(b[g]).onsuccess=function(a){c({error:0,message:"save success!",data:{total:f,index:a.target.result}})};return d},b.del=function(c,e){var g=d.db.transaction([a],"readwrite").objectStore(a),h=0,i=b.getKeyRangeValue(c[1]),j=function(a,b){var c=a.target.result;window.console.log(c),c?(h++,window.console.log(c),c.delete(),c.continue()):b({error:0,message:"delAll success of total "+h,total:h})};return d.callback=e,g.transaction.onerror=f,c[0]===g.keyPath?g.openCursor(i).onsuccess=function(a){window.console.log(i),j(a,e)}:g.index(c[0]+"Index").openCursor(i).onsuccess=function(a){j(a,e)},d},b.total=function(b){var c=d.db.transaction([a],"readwrite").objectStore(a);d.callback=b,c.transaction.onerror=f,c.count().onsuccess=function(a){b({error:0,message:"total "+a.target.result+" !",data:a.target.result})}},b.clear=function(b){var c=d.db.transaction([a],"readwrite").objectStore(a);return d.callback=b,c.transaction.onerror=f,c.clear().onsuccess=function(a){window.console.log(a),b({error:0,message:"clear success!"})},d},b):d},this.remove=function(a){return e.deleteDatabase(a||d.name),d}};