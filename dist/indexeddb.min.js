/*! indexedDB 2016-12-01 */
!function(a,b){a.indexedDB=a.indexedDB||a.webkitIndexedDB||a.mozIndexedDB||a.msIndexedDB,a.IDBTransaction=a.IDBTransaction||a.webkitIDBTransaction||a.msIDBTransaction,a.IDBKeyRange=a.IDBKeyRange||a.webkitIDBKeyRange||a.msIDBKeyRange,a.IDBCursor=a.IDBCursor||a.webkitIDBCursor||a.msIDBCursor;var c=function(a,b,c){var d,e,f=[];for(d in c)switch(c[d][1]){case"primary":e=a.createObjectStore(b,{keyPath:c[d][0],autoIncrement:"AI"===c[d][2]});break;case"relation":f.push([c[d][0]+"Index",c[d][2],{unique:!1,multiEntry:!1}]);break;default:f.push([c[d][0]+"Index",c[d][0],{unique:"unique"===c[d][1],multiEntry:"ME"===c[d][2]}])}void 0===e.name&&(e=a.createObjectStore(b,{keyPath:"id",autoIncrement:!0}));for(d in f)e.createIndex(f[d][0],f[d][1],f[d][2])},d=function(b){var c;switch(b[0]){case"gt":c=a.IDBKeyRange.lowerBound(b[1],void 0===b[2]||b[2]);break;case"lt":c=a.IDBKeyRange.upperBound(b[1],void 0===b[2]||b[2]);break;case"bt":c=a.IDBKeyRange.bound(b[1][0],b[1][1],void 0===b[2]||b[2],void 0===b[3]||b[3]);break;case"eq":c=a.IDBKeyRange.only(b[1]);break;case"lk":c=a.IDBKeyRange.includes(b[1]);break;default:c=!1}return c},e=function(a){return"function"==typeof a},f=function(a){if(e(a))throw"this is Function";var b=!0;for(var c in a){b=!1;break}return b},g=function(a,b){return this.name=b,this.callback=a,this.emit=function(a){this.callback(a)},this},h=function(a){var b=function(b){i.call(this,b),this.result=a.DB,delete this.database,delete this.version,delete this.initialCollections};b.prototype={constructor:b,getDatabase:function(){return this.result.database},find:function(a,b){void 0!==a&&null!==a||(a=["*"]),e(a)&&(b=a,a=["*"]);var c=this.on("success",b),f=this.on("error",b),g=this.getDatabase().transaction([this.name],"readonly").objectStore(this.name),h=0,i=[],j="*"===a[0]?null:d(a[1]);if(null===j){var k=g.getAll();k.onsuccess=function(a){c.emit({error:0,message:"find success",data:{result:a.target.result,total:a.target.result.length}})},k.onerror=function(a){f.emit({error:1010,message:"find error",data:a})}}else{var l=function(b){var d=b.target.result;d?(h++,i.push(d.value),d.continue()):c.emit({error:0,message:"select success of total "+h,data:{result:i,total:h,query:a}})};g.transaction.onerror=function(a){f.emit({error:1010,message:"find error",data:a})},a[0]===g.keyPath?g.openCursor(j,void 0===a[2]?"prev":a[2]).onsuccess=function(a){l(a)}:g.index(a[0]+"Index").openCursor(j,void 0===a[2]?"prev":a[2]).onsuccess=function(a){l(a)}}return this},findOne:function(a,b){var c=this.on("success",b),d=this.on("error",b),e=this.getDatabase().transaction([this.name],"readonly").objectStore(this.name);e.transaction.onerror=function(a){d.emit({error:-1,message:"findOne operation fail!",data:a})};var f=function(a){c.emit({error:0,message:"find success!",data:{result:a.target.result}})};return a[0]===e.keyPath?e.get(a[1]).onsuccess=function(a){f(a)}:e.index(a[0]+"Index").get(a[1]).onsuccess=function(a){f(a)},this},insert:function(a,b){var c=this.on("success",b),d=this.on("error",b),e=this.getDatabase().transaction([this.name],"readwrite").objectStore(this.name).add(a);return e.error=function(a){d.emit({error:-1,message:"add fail!",data:a})},e.onsuccess=function(a){c.emit({error:0,message:"add success!",index:a.target.result})},this},batchInsert:function(a,b){var c=this.on("success",b),d=this.on("error",b),e=this,f=null===a||void 0===a?0:a.length;if(0===f)d.emit({error:-1,message:"no data!"});else{var g=function(b,e,g){if(e.indexOf(a[b][g.keyPath])===-1){var h=g.add(a[b]);h.onsuccess=function(a){c.emit({error:0,message:"insert success!",data:{total:f,index:a.target.result}})},h.onerror=function(a){d.emit({error:-1,message:"insert fail!",data:a})}}else d.emit({error:-1,message:"primary already exists"})};this.keys(function(a){for(var b=e.getDatabase().transaction([e.name],"readwrite").objectStore(e.name),c=a.data.result,d=0;d<f;d++)g(d,c,b)})}return this},update:function(a,b){console.log("待增加！")},save:function(a,b){var c=this.on("success",b),d=this.on("error",b);if(void 0===a||f(a))throw"no update data";var e=this.getDatabase().transaction([this.name],"readwrite").objectStore(this.name).put(a);return e.onerror=function(a){d.emit({error:-1,message:"save fail!",data:a})},e.onsuccess=function(a){c.emit({error:0,message:"save success!",data:{index:a.target.result}})},this},remove:function(a,b){("function"==typeof a||f(a))&&(b=a,a=["*"]);var c=this.on("success",b),e=this.on("error",b),g=this.getDatabase().transaction([this.name],"readwrite").objectStore(this.name);if("*"===a[0]){var h=g.clear();h.onsuccess=function(a){c.emit({error:0,message:"clear success!",data:a})},h.onerror=function(a){e.emit({error:-1,message:"clear fail!"})}}else{var i=d(a[1]),j=0,k=function(a){var b=a.target.result;b?(j++,window.console.log(b),b.delete(),b.continue()):c.emit({error:0,message:"delete success of total "+j,data:{total:j}})};a[0]===g.keyPath?g.openCursor(i).onsuccess=function(a){window.console.log(i),k(a)}:g.index(a[0]+"Index").openCursor(i).onsuccess=function(a){k(a)}}return this},count:function(a){var b=this.on("success",a),c=this.on("error",a),d=this.getDatabase().transaction([this.name],"readwrite").objectStore(this.name);return d.transaction.onerror=function(a){c.emit({error:0,message:"action fail!",data:a})},d.count().onsuccess=function(a){b.emit({error:0,message:"total "+a.target.result+" !",data:{count:a.target.result}}),console.log(a.target.result)},this},keys:function(a){var b=this.on("success",a),c=this.on("error",a),d=this.getDatabase().transaction([this.name],"readwrite").objectStore(this.name).getAllKeys();d.onsuccess=function(a){b.emit({error:0,message:"get success",data:{result:a.target.result}})},d.onerror=function(a){c.emit({error:-1,message:"get fail",data:a})}},drop:function(a){var b=this.on("success",a),c=(this.on("error",a),this.result.updateVersion(this.getDatabase()));console.log(c);var d=this;return c.onupgradeneeded=function(a){d.result.database=a.target.result,d.getDatabase().deleteObjectStore(d.name),delete d.result[d.name],b.emit({error:0,message:d.name+" removed and version update to "+d.getDatabase().version+"!"})},this}},a.DB[a.collectionName]=new b(a.collectionName)},i=function(a,b){"use strict";if(this.name=a,void 0===this.name)throw"name is empty!";this.initialCollections=b?b:{},this.database=null,this.type="indexedDB",this.version=void 0,this.callfn=[],this.on=function(a,b){return"function"==typeof b?new g(b,a):this}};i.prototype={constructor:i,open:function(b){var d=this.on("open",b),e=(this.on("success",b),this.on("error",b));if(null===a.indexedDB)throw"indexedDB don't support!";var f=a.indexedDB.open(this.name,this.version),g=this;return f.onupgradeneeded=function(a){for(var b in g.initialCollections)c(a.target.result,b,g.initialCollections[b])},f.onsuccess=function(a){g.database=a.target.result,g.version=g.database.version;for(var b in g.initialCollections)h({DB:g,collectionName:b});d.emit({error:0,message:"open success!",data:{DB:g}})},f.onerror=function(a){e.emit({error:0,message:"open database fail!",result:a})},this},updateVersion:function(b){return b.close(),this.version++,a.indexedDB.open(this.name,this.version)},getCollection:function(a){return this[a]},drop:function(b,c){"function"==typeof b&&(c=b,b=this.name);var d=a.indexedDB.deleteDatabase(b||this.name);return c({error:0,message:"delete database success",data:d}),this}},a[b]=i}(window,"DB");